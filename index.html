<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grade 2 English Review - Damon's Edition</title>
    <!-- ä½¿ç”¨ Tailwind CSS é€²è¡Œæ’ç‰ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥åœ–æ¨™åº« -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts å­—å‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥ confetti ç‰¹æ•ˆ (æ…¶ç¥ç”¨ç´™èŠ±) -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #ecfeff; /* æ›´æ¸…çˆ½çš„è—ç¶ è‰²èƒŒæ™¯ */
            background-image: radial-gradient(#cffafe 2px, transparent 2px);
            background-size: 30px 30px;
        }
        .en-text {
            font-family: 'Fredoka', sans-serif;
        }
        .playing-highlight {
            background-color: #fef9c3 !important; /* æŸ”å’Œé»ƒ */
            border-color: #facc15 !important;
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1);
        }
        /* é ç±¤åˆ‡æ›å‹•ç•« */
        .tab-active {
            background-color: #ffffff;
            color: #0ea5e9;
            font-weight: bold;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .tab-inactive {
            background-color: rgba(255, 255, 255, 0.4);
            color: #475569;
        }
        
        /* æ¸¬é©—æ¨¡å¼æŒ‰éˆ•æ¨£å¼ */
        .quiz-option {
            transition: all 0.2s;
            cursor: pointer;
        }
        .quiz-option:hover {
            transform: scale(1.02);
            background-color: #eff6ff;
        }
        .quiz-option.correct {
            background-color: #dcfce7 !important;
            border-color: #22c55e !important;
            color: #14532d;
        }
        .quiz-option.wrong {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
            color: #7f1d1d;
            opacity: 0.7;
        }
        /* è²¼ç´™æ•ˆæœ */
        .sticker-img {
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.1));
            font-size: 2.5rem;
            line-height: 1;
        }
    </style>
</head>
<body class="min-h-screen pb-24 select-none">

    <!-- é ‚éƒ¨å°èˆª -->
    <header class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold flex items-center gap-2">
                        <i class="fas fa-graduation-cap"></i> Damon's English
                    </h1>
                </div>
                <!-- èªé€Ÿèˆ‡åˆ†æ•¸å€ -->
                <div class="flex items-center gap-3">
                    <!-- èªé€Ÿæ§åˆ¶å™¨ -->
                    <div class="bg-white/20 rounded-full px-3 py-1 flex items-center gap-2 text-sm backdrop-blur-sm border border-white/30">
                        <i class="fas fa-tachometer-alt text-cyan-100"></i>
                        <select id="speed-select" onchange="updateSpeed()" class="bg-transparent text-white font-bold outline-none cursor-pointer appearance-none">
                            <option value="1.0" class="text-gray-800">1.0x (Normal)</option>
                            <option value="0.75" class="text-gray-800" selected>0.75x (Slow)</option>
                            <option value="0.5" class="text-gray-800">0.5x (Very Slow)</option>
                        </select>
                        <i class="fas fa-chevron-down text-xs text-cyan-100"></i>
                    </div>

                    <!-- åˆ†æ•¸é¡¯ç¤º (åƒ…åœ¨æ¸¬é©—æ¨¡å¼é¡¯ç¤º) -->
                    <div id="score-board" class="hidden bg-yellow-400/90 text-yellow-900 px-3 py-1 rounded-full shadow-sm">
                        <span class="font-bold text-sm"><i class="fas fa-star"></i> <span id="current-score">0</span></span>
                    </div>
                </div>
            </div>

            <!-- æ¨¡å¼åˆ‡æ› Tabs -->
            <div class="flex gap-2 p-1 bg-black/10 rounded-xl backdrop-blur-sm">
                <button onclick="switchMode('practice')" id="tab-practice" class="tab-active flex-1 py-2 rounded-lg text-center transition text-sm md:text-base">
                    <i class="fas fa-book-open mr-2"></i>ç·´ç¿’æ¨¡å¼
                </button>
                <button onclick="switchMode('quiz')" id="tab-quiz" class="tab-inactive flex-1 py-2 rounded-lg text-center transition text-sm md:text-base">
                    <i class="fas fa-gamepad mr-2"></i>æ¸¬é©—æ¨¡å¼
                </button>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹å€ -->
    <main class="max-w-4xl mx-auto px-4 py-6">
        
        <!-- 1. ç·´ç¿’æ¨¡å¼ç•Œé¢ -->
        <div id="view-practice" class="space-y-6">
            <!-- å…¨å±€æ’­æ”¾æ§åˆ¶ (æµ®å‹•æŒ‰éˆ•) -->
            <div class="flex justify-center md:justify-end mb-4 sticky top-40 z-40 pointer-events-none">
                <div class="pointer-events-auto bg-white/90 backdrop-blur-md shadow-lg rounded-full p-1.5 border border-white/50 flex gap-2">
                    <button id="stopBtn" onclick="stopAudio()" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full shadow transition flex items-center gap-2">
                        <i class="fas fa-stop"></i> Stop
                    </button>
                    <button id="playAllBtn" onclick="playAll()" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-6 rounded-full shadow transition flex items-center gap-2 animate-pulse-slow">
                        <i class="fas fa-play-circle text-xl"></i> Play All
                    </button>
                </div>
            </div>
            
            <div id="content-list" class="space-y-8">
                <!-- èª²ç¨‹å…§å®¹ç”± JS ç”Ÿæˆ -->
            </div>
        </div>

        <!-- 2. æ¸¬é©—æ¨¡å¼ç•Œé¢ -->
        <div id="view-quiz" class="hidden max-w-2xl mx-auto mt-8">
            <div class="bg-white rounded-3xl shadow-xl overflow-hidden border-4 border-white ring-4 ring-cyan-100">
                <!-- æ¸¬é©—ç‹€æ…‹æ¬„ -->
                <div class="bg-gradient-to-b from-cyan-50 to-white p-8 text-center border-b border-cyan-100">
                    <div class="relative inline-block group">
                        <div class="absolute inset-0 bg-cyan-400 rounded-full blur opacity-20 group-hover:opacity-40 transition"></div>
                        <div class="relative inline-flex items-center justify-center w-24 h-24 rounded-full bg-gradient-to-br from-cyan-100 to-blue-50 text-cyan-600 mb-4 shadow-lg cursor-pointer hover:scale-105 transition border-4 border-white" onclick="playQuizAudio()">
                            <i id="quiz-speaker-icon" class="fas fa-volume-up text-4xl"></i>
                        </div>
                    </div>
                    <p class="text-slate-500 text-sm font-bold mb-1 tracking-wide uppercase">Listen & Choose</p>
                    <p class="text-slate-800 font-black text-xl">é»æ“Šå–‡å­è½é¡Œç›®ï¼Œé¸å‡ºæ­£ç¢ºç­”æ¡ˆ</p>
                </div>

                <!-- é¸é …å€ -->
                <div id="quiz-options" class="p-6 space-y-4 bg-slate-50 min-h-[300px] flex flex-col justify-center">
                    <!-- é¸é …ç”± JS ç”Ÿæˆ -->
                    <div class="text-center py-10">
                        <button onclick="startQuiz()" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-4 px-10 rounded-2xl shadow-lg transform transition hover:scale-105 text-lg">
                            <i class="fas fa-rocket mr-2"></i> é–‹å§‹æ¸¬é©— (Start Quiz)
                        </button>
                    </div>
                </div>

                <!-- åº•éƒ¨åé¥‹ -->
                <div id="quiz-feedback" class="h-14 bg-white border-t border-slate-100 flex items-center justify-center text-sm font-bold text-slate-400">
                    <i class="fas fa-info-circle mr-2"></i> æº–å‚™å¥½å°±æŒ‰é–‹å§‹ï¼
                </div>
            </div>
        </div>

    </main>

    <!-- åº•éƒ¨ç‰ˆæ¬Š -->
    <footer class="text-center text-slate-400 text-xs py-8">
        <p>Made for Damon â€¢ V3.1</p>
    </footer>

    <script>
        // === æ•™æè³‡æ–™åº« (V3.1: Phonics åœ–ç‰‡æ›´æ–°ç‚ºé›™åœ–ç¤º) ===
        const lessonData = [
            {
                category: "Greeting (å•å€™)",
                icon: "fa-hand-sparkles",
                color: "border-l-8 border-yellow-400",
                sentences: [
                    { en: "Hi! Good morning.", zh: "å—¨ï¼æ—©å®‰ã€‚", img: "â˜€ï¸" },
                    { en: "Hello! Good afternoon.", zh: "å“ˆå›‰ï¼åˆå®‰ã€‚", img: "ğŸ‘‹" }
                ]
            },
            {
                category: "1. Self Introduction (è‡ªæˆ‘ä»‹ç´¹)",
                subtitle: "Hello, Damon!",
                icon: "fa-id-card",
                color: "border-l-8 border-blue-400",
                sentences: [
                    { en: "My name is Damon.", zh: "æˆ‘çš„åå­—æ˜¯ Damonã€‚", img: "ğŸ‘¦" },
                    { en: "I am Damon.", zh: "æˆ‘æ˜¯ Damonã€‚", img: "ğŸ™‹â€â™‚ï¸" },
                    { en: "I'm Damon.", zh: "æˆ‘æ˜¯ Damonã€‚", img: "âœ¨" }
                ]
            },
            {
                category: "2. Age (å¹´é½¡)",
                subtitle: "How old are you?",
                icon: "fa-birthday-cake",
                color: "border-l-8 border-pink-400",
                sentences: [
                    { en: "I'm seven years old.", zh: "æˆ‘ä¸ƒæ­²ã€‚", img: "7ï¸âƒ£" },
                    { en: "I'm eight years old.", zh: "æˆ‘å…«æ­²ã€‚", img: "8ï¸âƒ£" }
                ]
            },
            {
                category: "3. Feelings (å¿ƒæƒ…)",
                subtitle: "How are you today?",
                icon: "fa-smile-beam",
                color: "border-l-8 border-green-400",
                sentences: [
                    { en: "I'm great.", zh: "æˆ‘å¾ˆæ£’ã€‚", img: "ğŸ¤©" },
                    { en: "I'm good.", zh: "æˆ‘å¾ˆå¥½ã€‚", img: "ğŸ‘" },
                    { en: "I'm fine.", zh: "æˆ‘ä¸éŒ¯ã€‚", img: "ğŸ‘Œ" },
                    { en: "I'm happy.", zh: "æˆ‘å¾ˆé–‹å¿ƒã€‚", img: "ğŸ¥°" }
                ]
            },
            {
                category: "4. Weather (å¤©æ°£)",
                subtitle: "How's the weather?",
                icon: "fa-cloud-sun",
                color: "border-l-8 border-orange-400",
                sentences: [
                    { en: "It's sunny.", zh: "æ˜¯æ™´å¤©ã€‚", img: "â˜€ï¸" },
                    { en: "It's cloudy.", zh: "æ˜¯é™°å¤©ã€‚", img: "â˜ï¸" },
                    { en: "It's rainy.", zh: "æ˜¯é›¨å¤©ã€‚", img: "â˜”" },
                    { en: "It's windy.", zh: "é¢¨å¾ˆå¤§ã€‚", img: "ğŸƒ" },
                    { en: "It's snowy.", zh: "ä¸‹é›ªäº†ã€‚", img: "â›„" },
                    { en: "It's stormy.", zh: "æœ‰æš´é¢¨é›¨ã€‚", img: "â›ˆï¸" }
                ]
            },
            {
                category: "5. Phonics (ç™¼éŸ³)",
                subtitle: "Listen & Repeat",
                icon: "fa-shapes",
                color: "border-l-8 border-purple-400",
                sentences: [
                    // é€™è£¡æ›´æ–°ç‚ºé›™åœ–ç¤ºï¼Œå¹«åŠ©å­¸ç¿’
                    { en: "A, a, apple, ant", zh: "Aa (è˜‹æœ, èèŸ»)", img: "ğŸ ğŸœ" },
                    { en: "B, b, ball, bear", zh: "Bb (çƒ, ç†Š)", img: "ğŸ€ ğŸ»" },
                    { en: "C, c, cat, car", zh: "Cc (è²“, è»Šå­)", img: "ğŸ± ğŸš—" },
                    { en: "D, d, dog, duck", zh: "Dd (ç‹—, é´¨å­)", img: "ğŸ¶ ğŸ¦†" },
                    { en: "E, e, egg, elephant", zh: "Ee (è›‹, å¤§è±¡)", img: "ğŸ¥š ğŸ˜" },
                    { en: "F, f, fish, fan", zh: "Ff (é­š, é¢¨æ‰‡)", img: "ğŸŸ ğŸª­" },
                    { en: "G, g, goat, girl", zh: "Gg (å±±ç¾Š, å¥³å­©)", img: "ğŸ ğŸ‘§" },
                    { en: "H, h, hat, hot", zh: "Hh (å¸½å­, ç†±)", img: "ğŸ© ğŸ”¥" }
                ]
            },
            {
                category: "6. Singular (å–®æ•¸)",
                subtitle: "This is / That is",
                icon: "fa-cube",
                color: "border-l-8 border-teal-400",
                sentences: [
                    { en: "This is an ant.", zh: "é€™æ˜¯ä¸€éš»èèŸ»ã€‚", img: "ğŸœ" },
                    { en: "That is an ant.", zh: "é‚£æ˜¯ä¸€éš»èèŸ»ã€‚", img: "ğŸœ" },
                    { en: "This is a cat.", zh: "é€™æ˜¯ä¸€éš»è²“ã€‚", img: "ğŸ±" },
                    { en: "That is a cat.", zh: "é‚£æ˜¯ä¸€éš»è²“ã€‚", img: "ğŸˆ" },
                    { en: "This is a bear.", zh: "é€™æ˜¯ä¸€éš»ç†Šã€‚", img: "ğŸ»" },
                    { en: "That is a bear.", zh: "é‚£æ˜¯ä¸€éš»ç†Šã€‚", img: "ğŸ§¸" },
                    { en: "This is an insect.", zh: "é€™æ˜¯ä¸€éš»æ˜†èŸ²ã€‚", img: "ğŸª²" },
                    { en: "That is an insect.", zh: "é‚£æ˜¯ä¸€éš»æ˜†èŸ²ã€‚", img: "ğŸ" },
                    { en: "This is an apple.", zh: "é€™æ˜¯ä¸€é¡†è˜‹æœã€‚", img: "ğŸ" },
                    { en: "That is an apple.", zh: "é‚£æ˜¯ä¸€é¡†è˜‹æœã€‚", img: "ğŸ" },
                    { en: "This is a monkey.", zh: "é€™æ˜¯ä¸€éš»çŒ´å­ã€‚", img: "ğŸµ" },
                    { en: "That is a monkey.", zh: "é‚£æ˜¯ä¸€éš»çŒ´å­ã€‚", img: "ğŸ’" }
                ]
            },
            {
                category: "7. Plural (è¤‡æ•¸)",
                subtitle: "These are / Those are",
                icon: "fa-cubes",
                color: "border-l-8 border-red-400",
                sentences: [
                    { en: "These are apples.", zh: "é€™äº›æ˜¯è˜‹æœã€‚", img: "ğŸ" },
                    { en: "Those are apples.", zh: "é‚£äº›æ˜¯è˜‹æœã€‚", img: "ğŸ" },
                    { en: "These are balls.", zh: "é€™äº›æ˜¯çƒã€‚", img: "âš½" },
                    { en: "Those are balls.", zh: "é‚£äº›æ˜¯çƒã€‚", img: "ğŸ€" },
                    { en: "These are cars.", zh: "é€™äº›æ˜¯è»Šå­ã€‚", img: "ğŸš—" },
                    { en: "Those are cars.", zh: "é‚£äº›æ˜¯è»Šå­ã€‚", img: "ğŸš•" },
                    { en: "These are hats.", zh: "é€™äº›æ˜¯å¸½å­ã€‚", img: "ğŸ§¢" },
                    { en: "Those are hats.", zh: "é‚£äº›æ˜¯å¸½å­ã€‚", img: "ğŸ‘’" },
                    { en: "These are jackets.", zh: "é€™äº›æ˜¯å¤¾å…‹ã€‚", img: "ğŸ§¥" },
                    { en: "Those are jackets.", zh: "é‚£äº›æ˜¯å¤¾å…‹ã€‚", img: "ğŸ§¥" },
                    { en: "These are lions.", zh: "é€™äº›æ˜¯ç…å­ã€‚", img: "ğŸ¦" },
                    { en: "Those are lions.", zh: "é‚£äº›æ˜¯ç…å­ã€‚", img: "ğŸ¦" }
                ]
            },
            {
                category: "8. Colors & Clothes (é¡è‰²/è¡£ç‰©)",
                subtitle: "What color is it?",
                icon: "fa-tshirt",
                color: "border-l-8 border-indigo-400",
                sentences: [
                    { en: "It's a blue T-shirt.", zh: "æ˜¯ä¸€ä»¶è—è‰² T æ¤ã€‚", img: "ğŸ‘•" },
                    { en: "It's a green skirt.", zh: "æ˜¯ä¸€ä»¶ç¶ è‰²è£™å­ã€‚", img: "ğŸ‘—" }, // ç¶ è‰²è£™å­ç„¡ç²¾ç¢º Emojiï¼Œç”¨é€šç”¨è£™å­
                    { en: "It's a yellow cap.", zh: "æ˜¯ä¸€é ‚é»ƒè‰²å¸½å­ã€‚", img: "ğŸ§¢" },
                    { en: "It's a pink dress.", zh: "æ˜¯ä¸€ä»¶ç²‰è‰²æ´‹è£ã€‚", img: "ğŸ‘š" },
                    { en: "It's a red jacket.", zh: "æ˜¯ä¸€ä»¶ç´…è‰²å¤–å¥—ã€‚", img: "ğŸ§¥" }
                ]
            },
            {
                category: "9. Fruits (æ°´æœå–œå¥½)",
                subtitle: "Which fruit do you like?",
                icon: "fa-lemon",
                color: "border-l-8 border-lime-500",
                sentences: [
                    { en: "I like apples.", zh: "æˆ‘å–œæ­¡è˜‹æœã€‚", img: "ğŸ" },
                    { en: "I like bananas.", zh: "æˆ‘å–œæ­¡é¦™è•‰ã€‚", img: "ğŸŒ" },
                    { en: "I like mangos.", zh: "æˆ‘å–œæ­¡èŠ’æœã€‚", img: "ğŸ¥­" },
                    { en: "I like papayas.", zh: "æˆ‘å–œæ­¡æœ¨ç“œã€‚", img: "ğŸˆ" },
                    { en: "I like guavas.", zh: "æˆ‘å–œæ­¡èŠ­æ¨‚ã€‚", img: "ğŸ" }
                ]
            },
            {
                category: "10. Math (æ•¸å­¸)",
                subtitle: "Read the problem",
                icon: "fa-calculator",
                color: "border-l-8 border-gray-500",
                sentences: [
                    { en: "Thirty-five plus twenty equals fifty-five.", zh: "35 + 20 = 55", img: "â•" },
                    { en: "One hundred minus fifteen equals eighty-five.", zh: "100 - 15 = 85", img: "â–" }
                ]
            }
        ];

        // æ‰å¹³åŒ–æ‰€æœ‰å¥å­
        let allSentencesFlat = [];
        lessonData.forEach(section => {
            section.sentences.forEach(s => allSentencesFlat.push(s));
        });

        // === æ ¸å¿ƒåŠŸèƒ½è®Šæ•¸ ===
        const synth = window.speechSynthesis;
        let sentencesToPlay = [];
        let isPlayingAll = false;
        let currentUtterance = null;
        let currentQuizItem = null;
        let score = 0;
        let isQuizMode = false;
        let speechRate = 0.75; // é è¨­æ…¢é€Ÿ

        // === 1. åˆå§‹åŒ–é é¢ ===
        function initPage() {
            const container = document.getElementById('content-list');
            
            lessonData.forEach((section, sIndex) => {
                const sectionEl = document.createElement('section');
                sectionEl.className = "bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden hover:shadow-md transition duration-300";
                
                // å€å¡Šæ¨™é¡Œ
                let headerHtml = `
                    <div class="p-4 bg-gradient-to-r from-slate-50 to-white border-b border-slate-100 flex items-center gap-4">
                        <div class="w-12 h-12 rounded-2xl bg-white shadow-sm text-${section.color.split('-')[3]}-500 border border-slate-100 flex items-center justify-center shrink-0 text-xl">
                            <i class="fas ${section.icon}"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">${section.category}</h2>
                            ${section.subtitle ? `<p class="text-sm text-slate-500 font-medium">${section.subtitle}</p>` : ''}
                        </div>
                    </div>
                `;

                // å¥å­åˆ—è¡¨
                let sentencesHtml = `<div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">`;
                
                section.sentences.forEach((item, iIndex) => {
                    const globalIndex = sentencesToPlay.length;
                    sentencesToPlay.push({ text: item.en, id: `card-${globalIndex}` }); 

                    // åˆ¤æ–·æ˜¯å¦æœ‰åœ–ç‰‡ï¼Œä¸¦å…è¨±å¯¬åº¦è‡ªå‹•é©æ‡‰é›™åœ–ç¤º (ä½¿ç”¨ min-w-[3rem] è®“å–®åœ–ç¤ºç½®ä¸­ï¼Œé›™åœ–ç¤ºå±•é–‹)
                    const imgHtml = item.img ? `<div class="sticker-img mr-3 min-w-[3rem] text-center transform group-hover:scale-110 transition">${item.img}</div>` : '';

                    sentencesHtml += `
                        <div id="card-${globalIndex}" 
                             onclick="speak('${item.en.replace(/'/g, "\\'")}', 'card-${globalIndex}')" 
                             class="card-hover ${section.color} bg-white border border-slate-100 rounded-xl p-4 flex items-center justify-between cursor-pointer select-none group relative overflow-hidden">
                            
                            <div class="flex items-center flex-1">
                                ${imgHtml}
                                <div>
                                    <p class="en-text text-xl text-slate-700 font-bold group-hover:text-cyan-600 transition tracking-wide">${item.en}</p>
                                    <p class="text-sm text-slate-400 mt-1 font-medium">${item.zh}</p>
                                </div>
                            </div>
                            
                            <div class="w-10 h-10 rounded-full bg-slate-50 group-hover:bg-cyan-50 text-slate-300 group-hover:text-cyan-500 flex items-center justify-center transition shrink-0 ml-2">
                                <i class="fas fa-volume-up"></i>
                            </div>
                        </div>
                    `;
                });
                
                sentencesHtml += `</div>`;
                sectionEl.innerHTML = headerHtml + sentencesHtml;
                container.appendChild(sectionEl);
            });
        }

        // === æ›´æ–°èªé€Ÿ ===
        function updateSpeed() {
            const select = document.getElementById('speed-select');
            speechRate = parseFloat(select.value);
            // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œåœæ­¢ä¸¦æç¤ºç”¨æˆ¶é‡æ–°é»æ“Š
            if (synth.speaking) {
                stopAudio();
            }
        }

        // === 2. æ¨¡å¼åˆ‡æ›é‚è¼¯ ===
        function switchMode(mode) {
            const practiceView = document.getElementById('view-practice');
            const quizView = document.getElementById('view-quiz');
            const tabPractice = document.getElementById('tab-practice');
            const tabQuiz = document.getElementById('tab-quiz');
            const scoreBoard = document.getElementById('score-board');

            stopAudio();

            if (mode === 'practice') {
                isQuizMode = false;
                practiceView.classList.remove('hidden');
                quizView.classList.add('hidden');
                
                tabPractice.className = "tab-active flex-1 py-2 rounded-lg text-center transition cursor-default";
                tabQuiz.className = "tab-inactive flex-1 py-2 rounded-lg text-center transition cursor-pointer";
                scoreBoard.classList.add('hidden');
            } else {
                isQuizMode = true;
                practiceView.classList.add('hidden');
                quizView.classList.remove('hidden');

                tabPractice.className = "tab-inactive flex-1 py-2 rounded-lg text-center transition cursor-pointer";
                tabQuiz.className = "tab-active flex-1 py-2 rounded-lg text-center transition cursor-default";
                scoreBoard.classList.remove('hidden');
                
                if(!currentQuizItem) startQuiz();
            }
        }

        // === 3. èªéŸ³åˆæˆåŠŸèƒ½ ===
        function speak(text, elementId, onEndCallback) {
            if (synth.speaking) synth.cancel();

            // UI æ›´æ–°
            document.querySelectorAll('.playing-highlight').forEach(el => el.classList.remove('playing-highlight'));
            if (elementId && !isQuizMode) {
                const el = document.getElementById(elementId);
                if (el) {
                    el.classList.add('playing-highlight');
                    if (isPlayingAll) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            const utterance = new SpeechSynthesisUtterance(text);
            currentUtterance = utterance;
            utterance.lang = 'en-US';
            utterance.rate = speechRate; // ä½¿ç”¨ç•¶å‰è¨­å®šçš„èªé€Ÿ
            utterance.pitch = 1.1;

            const voices = synth.getVoices();
            const preferredVoice = voices.find(v => v.name.includes('Google US English')) || voices.find(v => v.lang === 'en-US');
            if (preferredVoice) utterance.voice = preferredVoice;

            utterance.onend = () => {
                if (elementId && !isQuizMode) {
                    const el = document.getElementById(elementId);
                    if (el) el.classList.remove('playing-highlight');
                }
                if (onEndCallback) onEndCallback();
            };

            synth.speak(utterance);
        }

        // === 4. æ’­æ”¾æ§åˆ¶ ===
        function playAll() {
            if (isPlayingAll) return;
            isPlayingAll = true;
            updatePlayButtons();
            
            let index = 0;
            function playNext() {
                if (!isPlayingAll) return;
                if (index < sentencesToPlay.length) {
                    const item = sentencesToPlay[index];
                    speak(item.text, item.id, () => {
                        index++;
                        if (isPlayingAll) setTimeout(playNext, 1200); // ç¨å¾®å¢åŠ é–“éš”
                    });
                } else {
                    stopAudio();
                }
            }
            playNext();
        }

        function stopAudio() {
            synth.cancel();
            isPlayingAll = false;
            updatePlayButtons();
            document.querySelectorAll('.playing-highlight').forEach(el => el.classList.remove('playing-highlight'));
        }

        function updatePlayButtons() {
            const playBtn = document.getElementById('playAllBtn');
            const stopBtn = document.getElementById('stopBtn');
            if (isPlayingAll) {
                playBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
            } else {
                playBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            }
        }

        // === 5. æ¸¬é©—æ¨¡å¼ ===
        function startQuiz() {
            nextQuizQuestion();
        }

        function nextQuizQuestion() {
            const randomIndex = Math.floor(Math.random() * allSentencesFlat.length);
            currentQuizItem = allSentencesFlat[randomIndex];
            
            let options = [currentQuizItem];
            while (options.length < 3) {
                const randomDistractor = allSentencesFlat[Math.floor(Math.random() * allSentencesFlat.length)];
                if (!options.includes(randomDistractor) && randomDistractor.zh !== currentQuizItem.zh) {
                    options.push(randomDistractor);
                }
            }
            options.sort(() => Math.random() - 0.5);

            const optionsContainer = document.getElementById('quiz-options');
            const feedbackEl = document.getElementById('quiz-feedback');
            
            feedbackEl.innerHTML = "<i class='fas fa-headphones-alt mr-2'></i> é»å–‡å­è½é¡Œç›®ï¼Œå†é¸ç­”æ¡ˆ";
            feedbackEl.className = "h-14 bg-white border-t border-slate-100 flex items-center justify-center text-sm font-bold text-slate-400";

            let html = '';
            options.forEach((opt, idx) => {
                // æ¸¬é©—é¸é …ä¹Ÿé¡¯ç¤ºåœ–ç‰‡ï¼Œå¢åŠ è¯æƒ³
                const optImg = opt.img ? `<span class="text-2xl mr-2 filter drop-shadow-sm">${opt.img}</span>` : '';
                html += `
                    <div onclick="checkAnswer(this, '${opt.zh.replace(/'/g, "\\'")}')" 
                         class="quiz-option bg-white border-2 border-slate-200 rounded-xl p-4 text-center text-slate-700 font-bold text-lg shadow-sm flex items-center justify-center h-20">
                        ${optImg} ${opt.zh}
                    </div>
                `;
            });
            optionsContainer.innerHTML = html;

            setTimeout(() => playQuizAudio(), 400);
        }

        function playQuizAudio() {
            if (!currentQuizItem) return;
            const icon = document.getElementById('quiz-speaker-icon');
            icon.classList.add('text-cyan-400', 'scale-110');
            setTimeout(() => icon.classList.remove('text-cyan-400', 'scale-110'), 200);
            
            speak(currentQuizItem.en, null, null);
        }

        function checkAnswer(el, selectedZh) {
            if (document.querySelector('.quiz-option.correct') || document.querySelector('.quiz-option.wrong')) return;

            const feedbackEl = document.getElementById('quiz-feedback');

            if (selectedZh === currentQuizItem.zh) {
                el.classList.add('correct');
                el.innerHTML = `<i class="fas fa-check-circle text-2xl mr-2"></i> ${selectedZh}`;
                
                feedbackEl.innerHTML = "<span class='text-green-600 text-lg'><i class='fas fa-laugh-squint'></i> Correct! ç­”å°äº†ï¼</span>";
                feedbackEl.className = "h-14 bg-green-50 border-t border-green-100 flex items-center justify-center font-bold animate-pulse";
                
                score += 10;
                updateScore();
                fireConfetti();
                
                setTimeout(nextQuizQuestion, 2000);
            } else {
                el.classList.add('wrong');
                feedbackEl.innerHTML = "<span class='text-red-500 text-lg'><i class='fas fa-times-circle'></i> Oops! å†è©¦ä¸€æ¬¡ (Try again)</span>";
                feedbackEl.className = "h-14 bg-red-50 border-t border-red-100 flex items-center justify-center font-bold";
                
                // é™ä½èªé€Ÿå†å”¸ä¸€æ¬¡
                const originalRate = speechRate;
                speechRate = 0.5; // è®Šæ…¢
                setTimeout(() => {
                    playQuizAudio();
                    speechRate = originalRate; // æ¢å¾©
                }, 800);
            }
        }

        function updateScore() {
            document.getElementById('current-score').innerText = score;
        }

        function fireConfetti() {
            confetti({
                particleCount: 150,
                spread: 80,
                origin: { y: 0.6 },
                colors: ['#06b6d4', '#f59e0b', '#ef4444', '#10b981']
            });
        }

        window.speechSynthesis.onvoiceschanged = () => {
            window.speechSynthesis.getVoices();
        };

        // å•Ÿå‹•
        initPage();

    </script>
</body>
</html>
